# Environment setup for PRC watermark cropping experiments

This repository orchestrates experiments using the upstream [`PRC-Watermark`](./PRC-Watermark) implementation. The commands below keep the upstream code unmodified while preparing a local environment that can run encoding, cropping, decoding, and analysis.

## 1) Create and activate a virtual environment

```bash
python -m venv .venv
source .venv/bin/activate
```

## 2) Install dependencies

Install the Python requirements for the orchestration scripts and the upstream watermark implementation:

```bash
pip install --upgrade pip
pip install -r PRC-Watermark/requirements.txt
pip install pandas pillow matplotlib tqdm
```

## 3) Download model weights (one-time)

The upstream repository expects Stable Diffusion 2.1 weights from HuggingFace. Follow the instructions in `PRC-Watermark/README.md` to authenticate with HuggingFace (if needed) and let the encode/decode scripts download the model into your local cache. You can optionally set the cache location, for example:

```bash
export HF_HOME="$HOME/.cache/huggingface"
export HF_DATASETS_CACHE="$HF_HOME/datasets"
export HF_HUB_CACHE="$HF_HOME/hub"
```

## 4) Initialize the PRC-Watermark submodule

This repository vendor’s the official implementation as a git submodule. If it was not already initialized, run:

```bash
git submodule update --init --recursive
```

## 5) Confirm GPU availability (recommended)

PRC encoding and decoding are GPU-accelerated. Use `python - <<'PY'` to verify whether PyTorch sees a CUDA device:

```bash
python - <<'PY'
import torch
print('CUDA available:', torch.cuda.is_available())
if torch.cuda.is_available():
    print('Device:', torch.cuda.get_device_name())
PY
```

## 6) Suggested folder layout for runtime artifacts

Runtime data should **not** be committed. The default paths used by the orchestration scripts are:

- `PRC-Watermark/results/` – watermarked images produced by `encode.py` and cropped derivatives used by `decode.py`.
- `PRC-Watermark/keys/` – key files generated by the encoder.
- `data/` – optional scratch space for intermediate assets.

All of these paths are gitignored in this repository.

## 7) Quick smoke test

Generate a small batch of watermarked images to verify the pipeline (adjust `--test_num` and other flags as needed):

```bash
cd PRC-Watermark
python encode.py --test_num 2
python decode.py --test_num 2
cd ..
```

Successful decoding on unmodified images confirms that the core PRC-Watermark dependency works before running the cropping experiment.
